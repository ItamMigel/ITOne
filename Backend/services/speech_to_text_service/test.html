<!DOCTYPE html>
<html>
<head>
  <title>Speech-to-Text Test</title>
</head>
<body>
  <h1>Speech-to-Text Test</h1>
  <button id="startBtn">Start Recording</button>
  <button id="stopBtn" disabled>Stop Recording</button>
  <div id="results"></div>

  <script>
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const results = document.getElementById('results');
    let ws;
    let mediaRecorder;
    let audioChunks = [];

    startBtn.onclick = async () => {
      // Connect to WebSocket
      ws = new WebSocket('ws://localhost:8000/ws');
      
      ws.onopen = async () => {
        console.log('WebSocket connected');
        
        // Start recording
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        
        mediaRecorder.ondataavailable = event => {
          audioChunks.push(event.data);
          // Convert to ArrayBuffer and send over WebSocket
          event.data.arrayBuffer().then(buffer => {
            ws.send(buffer);
          });
        };
        
        mediaRecorder.start(100); // Capture in 100ms chunks
        startBtn.disabled = true;
        stopBtn.disabled = false;
      };
      
      ws.onmessage = event => {
        // Display transcription results
        const p = document.createElement('p');
        p.textContent = event.data;
        results.appendChild(p);
      };
      
      ws.onerror = error => {
        console.error('WebSocket error:', error);
      };
    };

    stopBtn.onclick = () => {
      if (mediaRecorder) {
        mediaRecorder.stop();
        mediaRecorder = null;
      }
      if (ws) {
        ws.close();
      }
      startBtn.disabled = false;
      stopBtn.disabled = true;
    };
  </script>
</body>
</html>